name: CI - Tests y Calidad del C√≥digo

# Se ejecuta en:
# 1. Pull requests hacia main (CR√çTICO para aprobar merges)
# 2. Push a cualquier rama (para feedback temprano)
on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Compilar y Ejecutar Tests
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Checkout del c√≥digo
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      # Paso 2: Configurar Java 17
      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Paso 3: Dar permisos de ejecuci√≥n a scripts (si tienes)
      - name: Permisos de ejecuci√≥n
        run: chmod +x compile.sh test.sh || true

      # Paso 4: Compilar el proyecto
      - name: Compilar c√≥digo fuente
        run: |
          echo "üî® Compilando c√≥digo fuente..."
          
          # Crear directorio bin si no existe
          mkdir -p bin
          
          # Compilar c√≥digo fuente (ajusta las rutas seg√∫n tu estructura)
          javac -d bin -sourcepath src src/**/*.java
          
          echo "‚úÖ Compilaci√≥n exitosa"
        continue-on-error: false

      # Paso 5: Compilar tests
      - name: Compilar tests
        run: |
          echo "Compilando tests..."
          
          # Descargar JUnit 5 si no est√° en el proyecto
          if [ ! -f "lib/junit-platform-console-standalone.jar" ]; then
            mkdir -p lib
            wget -q https://repo1.maven.org/maven2/org/junit/platform/junit-platform-console-standalone/1.10.0/junit-platform-console-standalone-1.10.0.jar -O lib/junit-platform-console-standalone.jar
          fi
          
          # Compilar tests
          javac -cp "bin:lib/junit-platform-console-standalone.jar" -d bin test/**/*.java || \
          javac -cp "bin:lib/junit-platform-console-standalone.jar" -d bin src/test/**/*.java || \
          echo "No se encontraron tests o ya est√°n compilados"
          
          echo "Tests compilados"
        continue-on-error: false

      # Paso 6: Ejecutar tests
      - name: Ejecutar tests unitarios
        run: |
          echo "Ejecutando tests..."
          
          # Ejecutar tests con JUnit
          java -jar lib/junit-platform-console-standalone.jar \
            --class-path bin \
            --scan-class-path \
            --fail-if-no-tests \
            --reports-dir=test-results
          
          echo "Todos los tests pasaron"
        continue-on-error: false

      # Paso 7: Subir resultados de tests
      - name: Subir resultados de tests
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30

  code-quality:
    name: Verificaci√≥n de Calidad de C√≥digo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      # Verificaci√≥n 1: M√°ximo tama√±o de l√≠nea (120 caracteres)
      - name: Verificar longitud m√°xima de l√≠neas
        run: |
          echo "Verificando longitud de l√≠neas (m√°x 120 caracteres)..."
          
          # Buscar l√≠neas demasiado largas en archivos .java
          LONG_LINES=$(find src -name "*.java" -exec awk 'length > 120 {print FILENAME ":" NR ": " $0; errors++} END {exit errors}' {} + 2>&1 || true)
          
          if [ ! -z "$LONG_LINES" ]; then
            echo "Se encontraron l√≠neas demasiado largas:"
            echo "$LONG_LINES" | head -20
            echo ""
            echo "Por favor, reduce estas l√≠neas a m√°ximo 120 caracteres."
            exit 1
          fi
          
          echo "Todas las l√≠neas cumplen con el l√≠mite"

      # Verificaci√≥n 2: No System.out.println en c√≥digo de producci√≥n
      - name: Verificar System.out/err en producci√≥n
        run: |
          echo "üîç Verificando uso de System.out/err..."
          
          # Buscar System.out.println pero ignorar App.java (vista)
          SYSOUT=$(find src/model src/controller src/repository -name "*.java" 2>/dev/null -exec grep -n "System\\.out\\.print\|System\\.err\\.print" {} + || true)
          
          if [ ! -z "$SYSOUT" ]; then
            echo "Advertencia: Se encontr√≥ System.out/err en c√≥digo de producci√≥n:"
            echo "$SYSOUT"
            echo ""
            echo "Considera usar un logger en lugar de System.out"
            # No fallar, solo warning
          else
            echo "No se encontr√≥ System.out/err en Model/Controller"
          fi

      # Verificaci√≥n 3: TODOs cr√≠ticos sin resolver
      - name: Buscar TODOs cr√≠ticos
        run: |
          echo "Buscando TODOs cr√≠ticos..."
          
          CRITICAL_TODOS=$(grep -r "TODO.*CRITICAL\|FIXME.*URGENT" src/ || true)
          
          if [ ! -z "$CRITICAL_TODOS" ]; then
            echo "Se encontraron TODOs cr√≠ticos sin resolver:"
            echo "$CRITICAL_TODOS"
            exit 1
          fi
          
          echo "No hay TODOs cr√≠ticos pendientes"

      # Verificaci√≥n 4: Archivos sin comentarios de test
      - name: Verificar documentaci√≥n de tests
        run: |
          echo "Verificando documentaci√≥n de tests..."
          
          # Contar tests documentados vs total
          TOTAL_TESTS=$(find test src/test -name "*Test.java" 2>/dev/null -exec grep -c "@Test" {} + | awk '{sum+=$1} END {print sum}' || echo "0")
          DOCUMENTED_TESTS=$(find test src/test -name "*Test.java" 2>/dev/null -exec grep -B3 "@Test" {} + | grep -c "Caja\|Test\|Partici√≥n\|Coverage" || echo "0")
          
          echo "Tests totales: $TOTAL_TESTS"
          echo "Tests documentados: $DOCUMENTED_TESTS"
          
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PERCENTAGE=$((DOCUMENTED_TESTS * 100 / TOTAL_TESTS))
            echo "Porcentaje documentado: ${PERCENTAGE}%"
          
            if [ "$PERCENTAGE" -lt 50 ]; then
              echo "Menos del 50% de tests est√°n documentados"
              echo "Considera a√±adir comentarios explicando qu√© prueba cada test"
            else
              echo "Buena documentaci√≥n de tests (${PERCENTAGE}%)"
            fi
          fi

      # Verificaci√≥n 5: Estructura del proyecto MVC
      - name: Verificar estructura MVC
        run: |
          echo "Verificando estructura MVC..."
          
          ERRORS=0
          
          # Verificar carpetas necesarias
          if [ ! -d "src/model" ] && [ ! -d "model" ]; then
            echo "Falta carpeta model/"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ ! -d "src/controller" ] && [ ! -d "controller" ]; then
            echo "Falta carpeta controller/"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ ! -d "src/repository" ] && [ ! -d "repository" ]; then
            echo "Falta carpeta repository/ (Mocks)"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ ! -d "test" ] && [ ! -d "src/test" ]; then
            echo "Falta carpeta de tests"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "La estructura MVC no est√° completa"
            exit 1
          fi
          
          echo "Estructura MVC correcta"

      # Verificaci√≥n 6: Naming conventions
      - name: Verificar convenciones de nombrado
        run: |
          echo "Verificando convenciones de nombrado..."
          
          # Verificar que clases empiezan con may√∫scula
          BAD_CLASSES=$(find src -name "*.java" -exec basename {} \; | grep -E "^[a-z]" || true)
          
          if [ ! -z "$BAD_CLASSES" ]; then
            echo "Archivos que no siguen PascalCase:"
            echo "$BAD_CLASSES"
          else
            echo "Nombres de clases correctos (PascalCase)"
          fi
          
          # Verificar que tests terminan en Test.java
          BAD_TEST_NAMES=$(find test src/test -name "*.java" 2>/dev/null | grep -v "Test\.java$" || true)
          
          if [ ! -z "$BAD_TEST_NAMES" ]; then
            echo "Archivos de test que no terminan en 'Test.java':"
            echo "$BAD_TEST_NAMES"
          else
            echo "Nombres de tests correctos"
          fi

  summary:
    name: Resumen CI/CD
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: always()

    steps:
      - name: Verificar estado de todos los jobs
        run: |
          echo "üìä Resumen de CI/CD"
          echo "===================="
          
          BUILD_STATUS="${{ needs.build-and-test.result }}"
          QUALITY_STATUS="${{ needs.code-quality.result }}"
          
          echo "Build y Tests: $BUILD_STATUS"
          echo "Calidad de C√≥digo: $QUALITY_STATUS"
          echo ""
          
          if [ "$BUILD_STATUS" != "success" ]; then
            echo "Los tests fallaron - Merge bloqueado"
            exit 1
          fi
          
          if [ "$QUALITY_STATUS" != "success" ]; then
            echo "La calidad de c√≥digo no cumple est√°ndares - Merge bloqueado"
            exit 1
          fi
          
          echo "Todos los checks pasaron correctamente"
          echo "El c√≥digo est√° listo para merge a main"